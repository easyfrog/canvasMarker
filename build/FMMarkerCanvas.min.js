function FMAnimation(a,b){this.work=a,this.frameRate=b||30,this._stop=!1,this._cnt=0,this._lastTime=null}function FMMarkerCanvas(a){var b=this;b.style={},Object.assign(b.style,{width:256,height:128,color:4473924,fontColor:0,font:"24px 微软雅黑",elements:[],background:{color:16777215,alpha:0}},a),b.ctx=document.createElement("canvas").getContext("2d"),b.isDrawing=!1,b._elements=[],b.ctx.canvas.width=b.style.width,b.ctx.canvas.height=b.style.height}FMAnimation.prototype={constructor:FMAnimation,get frameRate(){return this._frameRate},set frameRate(a){a=Math.max(Math.min(60,a),1),this._frameRate=a,this._renderStep=60/a},play:function(a){this._stop=!1,this._frame()},stop:function(){this._stop=!0},_frame:function(){if(this._cnt+=1,this._lastTime||(this._lastTime=Date.now()),this._cnt>=this._renderStep){this._cnt=0;var a=Date.now(),b=a-this._lastTime;this._lastTime=a,this.work&&this.work(b/1e3)}this._stop||requestAnimationFrame(this._frame.bind(this))}},FMMarkerCanvas.prototype={constructor:FMMarkerCanvas,toRgba:function(a,b){function c(a){if(a.length<6)for(var b=6-a.length,c=0;c<b;c++)a="0"+a;return a}function d(a,b,c){return parseInt("0x"+a.slice(b,c))}var e,f,g;if(b=void 0==b?1:b,"number"==typeof a?(a=a.toString(16),a=c(a)):"string"==typeof a&&(a=a.slice(1)),6!=a.length)throw"wrong color length: color 0xffffff, or #ffffff length = 6";return e=d(a,0,2),f=d(a,2,4),g=d(a,4,6),"rgba("+e+", "+f+", "+g+", "+b+")"},setStyle:function(a){function b(a){for(var b=0;b<c.style.elements.length;b++)if(c.style.elements[b].name==a)return c.style.elements[b]}var c=this;a&&(a.background&&Object.assign(c.style.background,a.background),a.elements&&a.elements.forEach(function(a){if(a.name){var c=b(a.name);Object.assign(c,a)}}))},readElementSytle:function(a){var b=this;void 0!=a.color&&(b.ctx.fillStyle=b.toRgba(a.color,a.alpha)),void 0!=a.strokeColor&&(b.ctx.strokeStyle=b.toRgba(a.strokeColor,a.strokeAlpha)),a.lineWidth&&(b.ctx.lineWidth=a.lineWidth),a.textBaseline?b.ctx.textBaseline=a.textBaseline:b.ctx.textBaseline="top",a.shadow?(void 0!=a.shadow.offsetX&&(b.ctx.shadowOffsetX=a.shadow.offsetX),void 0!=a.shadow.offsetY&&(b.ctx.shadowOffsetY=a.shadow.offsetY),void 0!=a.shadow.blur&&(b.ctx.shadowBlur=a.shadow.blur),void 0!=a.shadow.color&&(b.ctx.shadowColor=b.toRgba(a.shadow.color,a.shadow.alpha))):(b.ctx.shadowBlur=0,b.ctx.shadowOffsetX=0,b.ctx.shadowOffsetY=0)},getValue:function(a,b,c){var d=a[b],e={x:0,y:0};if(a.groups&&("x"==b||"y"==b))var e=a.groups.reduce(function(a,b){return{x:a.x+b.x,y:a.y+b.y}},e);return d<=1&&d>=0?c?this.style.width*d+e.x:this.style.height*d+e.y:d<0?c?this.style.width+d+e.x:this.style.height+d+e.y:c?d+e.x:d+e.y},getStyleByName:function(a){var b=null;return function c(d){if(d.elements&&!b)for(var e=0;e<d.elements.length;e++){var f=d.elements[e];f.name==a&&(b=f),c(f)}}(this.style),b},drawBackground:function(){this.ctx.fillStyle=this.toRgba(this.style.background.color,this.style.background.alpha),this.ctx.fillRect(0,0,this.style.width,this.style.height)},drawRoundRect:function(a,b){var c=this;if(c.readElementSytle(a),a.width&&a.height){var d=c.getValue(a,"x",!0),e=c.getValue(a,"y"),f=c.getValue(a,"width",!0),g=c.getValue(a,"height");c.ctx.beginPath(),b?c.ctx.roundRect(d,e,f,g,a.radius||5):c.ctx.rect(d,e,f,g),c.ctx.closePath(),void 0!=a.lineWidth&&void 0!=a.strokeColor&&c.ctx.stroke(),void 0!=a.color&&c.ctx.fill(),c.next()}},drawCircle:function(a){var b=this;if(void 0!=a.radius&&void 0!=a.point){b.readElementSytle(a);var c=b.getValue(a.point,"x",!0),d=b.getValue(a.point,"y");b.ctx.beginPath(),b.ctx.arc(c,d,a.radius,0,2*Math.PI,!0),b.ctx.closePath(),void 0!=a.lineWidth&&void 0!=a.strokeColor&&b.ctx.stroke(),void 0!=a.color&&b.ctx.fill(),b.next()}},drawShape:function(a){var b=this;if(!(void 0==a.points&&a.points.length<3)){b.readElementSytle(a),b.ctx.beginPath();for(var c=0;c<a.points.length;c++){var d=b.getValue(a.points[c],"x",!0),e=b.getValue(a.points[c],"y");0==c?b.ctx.moveTo(d,e):b.ctx.lineTo(d,e)}b.ctx.closePath(),void 0!=a.lineWidth&&void 0!=a.strokeColor&&b.ctx.stroke(),void 0!=a.color&&b.ctx.fill(),b.next()}},drawImage:function(a){function b(){c.readElementSytle(a);var b=c.getValue(a,"x",!0),d=c.getValue(a,"y");if(a.width&&a.height){var e=c.getValue(a,"width",!0),f=c.getValue(a,"height");c.ctx.drawImage(a.image,b,d,e,f)}else c.ctx.drawImage(a.image,b,d)}var c=this,d=null;a.image?(b(a.img),c.next()):(d=new Image,d.src=a.url,d.onload=function(){a.image=d,b(d),c.next()})},drawText:function(a){var b=this,c=a.font||b.style.font,d=c.match(/\d+/),e=24;d.length>0&&(e=parseInt(d[0])),b.readElementSytle(a),b.ctx.font=c;var f=b.getValue(a,"x",!0),g=b.getValue(a,"y");a.lineWidth&&(b.ctx.lineWidth=a.lineWidth,b.ctx.strokeStyle=a.strokeColor||16777215,b.ctx.strokeText(a.text,f,g)),b.ctx.fillText(a.text,f,g),b.next()},drawElement:function(a){if(a.visible===!1)return void this.next();if(a.groups)for(var b=0;b<a.groups.length;b++)if(a.groups[b].visible===!1)return void this.next();switch(a.type){case"image":this.drawImage(a);break;case"text":this.drawText(a);break;case"roundRect":this.drawRoundRect(a,!0);break;case"rect":this.drawRoundRect(a,!1);break;case"circle":this.drawCircle(a);break;case"shape":this.drawShape(a)}},normalizeStyle:function(a,b){if(a.elements)for(var c=0;c<a.elements.length;c++){var d=a.elements[c];if("group"==d.type){var e=[];b?(e=b.slice(),e.push(d)):e=[d],this.normalizeStyle(a.elements[c],e)}else b&&(d.groups=b),this._elements.push(d)}},next:function(){var a=this;a.index++,a.index<a._elements.length?a.drawElement(a._elements[a.index]):(a.isDrawing=!1,a.callback&&a.callback())},init:function(){this.update(null,!0)},update:function(a,b){var c=this;if(!c.isDrawing){b&&(c._elements=[],c.normalizeStyle(c.style)),c.isDrawing=!0,c.index=-1,c.setStyle(a);var d=c.style.width,e=c.style.height;d!=c.ctx.canvas.width&&(c.ctx.canvas.width=d),e!=c.ctx.canvas.height&&(c.ctx.canvas.height=e),c.ctx.clearRect(0,0,d,e),c.drawBackground(a),c.next()}}},CanvasRenderingContext2D.prototype.roundRect||(CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e){return this.beginPath(),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e),this.closePath(),this});